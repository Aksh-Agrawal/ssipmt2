# Story 9.3: Multilingual Text-to-Speech with Criteria TTS & Swaram AI

**User Story:**
As a user,
I want to receive spoken responses from the AI agent in my preferred language,
So that the interaction feels natural and accessible.

**Story Context:**

- **Integrates with:** The `agent-service`'s response generation logic and the PipeCat audio stream.
- **Technology:** Criteria TTS, Swaram AI, and the existing PipeCat integration.
- **Follows pattern:** The existing microservices architecture and the event-driven nature of the PipeCat pipeline.
- **Touch points:** This story adds new processors to the `agent-service`'s PipeCat pipeline to handle TTS and language-specific voice synthesis.

**Acceptance Criteria:**

1.  The `agent-service`'s response text is passed to Criteria TTS for synthesis.
2.  Swaram AI is used to determine the appropriate language and voice for the TTS output, based on the user's input language or a stored preference.
3.  Criteria TTS generates natural-sounding speech in the detected/preferred language.
4.  The generated audio is streamed back to the mobile application via PipeCat.
5.  The system correctly synthesizes speech in all supported languages (English, Hindi, Chhattisgarhi).
6.  The integration is covered by appropriate tests.
7.  No regression in existing functionality is verified.

**Technical Notes:**

- **Integration Approach:** Add Criteria TTS and Swaram AI processors to the PipeCat pipeline within the `agent-service` for the outgoing audio stream. Swaram AI will inform Criteria TTS about the target language and voice.
- **Existing Pattern Reference:** This builds directly on the PipeCat pipeline pattern established in the previous stories.
- **Key Constraints:** The latency of TTS generation and audio streaming should be low enough to maintain a natural conversational flow. API keys for Criteria TTS and Swaram AI must be managed securely.

**Minimal Risk Assessment:**

- **Primary Risk:** The naturalness and quality of the synthesized speech from Criteria TTS, especially across multiple languages and accents, and ensuring it aligns with user expectations.
- **Mitigation:** Conduct extensive user testing with native speakers for each supported language to gather feedback on TTS quality. Provide options for different voices or speaking styles if available.
- **Rollback:** The TTS component can be disabled within the PipeCat pipeline, allowing the system to revert to text-only responses if critical issues are found with the speech synthesis.

**Compatibility Verification:**

- [x] No breaking changes to existing APIs.
- [x] Database changes (if any) are additive only. (No DB changes expected for this story).
- [x] UI changes follow existing design patterns. (No direct UI changes for this story, as it's audio output).
- [x] Performance impact is negligible.

## Status

In Progress

## Tasks / Subtasks

- [x] **Task 1: Add Criteria TTS Service Integration**
  - [x] Subtask 1.1: Create `criteriaTtsService.ts` with synthesizeText and synthesizeAndStream functions (AC: #1, #3)
  - [x] Subtask 1.2: Add CRITERIA_TTS_API_KEY to centralized config (AC: #1)
  - [x] Subtask 1.3: Implement placeholder synthesis with graceful fallback when API key missing
- [x] **Task 2: Wire TTS into PipeCat Pipeline**
  - [x] Subtask 2.1: Add processOutgoingAudioPipeline function to pipecatProcessors.ts (AC: #1, #4)
  - [x] Subtask 2.2: Integrate Swaram AI language detection for voice selection (AC: #2)
  - [x] Subtask 2.3: Export outgoing pipeline from package index (AC: #4)
- [x] **Task 3: Add Configuration and Documentation**
  - [x] Subtask 3.1: Update .env.example with CRITERIA_TTS_API_KEY
  - [x] Subtask 3.2: Create verify-tts.ts runtime verification script
- [ ] **Task 4: Add Test Coverage**
  - [x] Subtask 4.1: Add unit test for processOutgoingAudioPipeline (AC: #6)
  - [ ] Subtask 4.2: Resolve Jest ESM compatibility to enable test execution (blocked - systemic issue)
  - [ ] Subtask 4.3: Add integration tests for multi-language synthesis (AC: #5, #6)
- [ ] **Task 5: Implement Real API Integration**
  - [ ] Subtask 5.1: Replace placeholder with actual Criteria TTS API calls (AC: #3)
  - [ ] Subtask 5.2: Implement voice mapping for supported languages (en, hi, Chhattisgarhi) (AC: #2, #5)
  - [ ] Subtask 5.3: Implement streaming audio delivery mechanism (AC: #4)
- [ ] **Task 6: Verify No Regressions**
  - [ ] Subtask 6.1: Run full test suite for agent-service (blocked by Jest ESM issue)
  - [ ] Subtask 6.2: Verify existing audio pipeline (STT) still functions

## Dev Notes

This story builds on the PipeCat pipeline pattern from Story 9.2. The implementation follows a phased approach:

**Phase 1 (Complete):** Foundational infrastructure

- Centralized config for API keys (`src/config.ts`)
- Criteria TTS service with placeholder implementation
- Outgoing audio pipeline integrated into PipeCat processors
- Runtime verification scripts for testing without full Jest suite

**Phase 2 (Pending):** Real API integration

- Actual Criteria TTS HTTP calls (need API documentation)
- Voice selection logic via Swaram AI
- Streaming implementation (replace Buffer returns with ReadableStream)

**Known Technical Debt:**

- Jest ESM/TypeScript compatibility issue blocks automated test execution across the monorepo
- This is a systemic problem (not introduced by this story) affecting all packages
- Runtime verification scripts (`verify-tts.ts`, `verify-deepgram.ts`) provide interim validation

**Testing:**

- Unit tests created but blocked by Jest ESM issue
- Runtime verification confirms pipeline executes and handles missing API keys gracefully
- Integration testing pending real API implementation

## Dev Agent Record

### Agent Model Used

GitHub Copilot (Claude 3.5 Sonnet)

### Debug Log References

```bash
# Runtime verification (bypasses Jest ESM issues)
cd packages/services/agent
node --loader ts-node/esm src/verify-tts.ts
# Output: Returns empty buffer when CRITERIA_TTS_API_KEY not configured (expected behavior)

node --loader ts-node/esm src/verify-deepgram.ts
# Output: Returns empty transcription when DEEPGRAM_API_KEY not configured (expected behavior)
```

### Completion Notes

- Created `criteriaTtsService.ts` with placeholder TTS synthesis (AC #1, #3)
- Added `processOutgoingAudioPipeline` to `pipecatProcessors.ts` integrating Criteria TTS (AC #1, #4)
- Updated centralized `config.ts` to include `CRITERIA_TTS_API_KEY` (secure key management)
- Updated all services (`swaramAiService`, `deepgramSttService`, `criteriaTtsService`) to use centralized CONFIG
- Fixed lint warning in `swaramAiService.ts` (unused parameter)
- Added `.env.example` documenting all required API keys for agent-service
- Created unit test `ttsProcessors.test.ts` for outgoing pipeline (AC #6 - partial)
- Created runtime verification scripts (`verify-tts.ts`, `verify-deepgram.ts`) for testing without Jest
- Exported `processOutgoingAudioPipeline` from package index for consumer access (AC #4)
- All services now use centralized CONFIG instead of direct process.env access (coding standard compliance)
- Lint passes with 0 warnings

**Blockers:**

- Jest ESM/TypeScript configuration prevents automated test execution (systemic repo issue)
- Real Criteria TTS API integration pending (need API docs and credentials)
- Streaming implementation skeletal (returns Buffer, needs ReadableStream for production)

**Partial AC Coverage:**

- AC #1: ✓ Infrastructure in place, placeholder synthesis works
- AC #2: ✓ Language parameter flows through pipeline (voice selection logic skeletal)
- AC #3: ⚠️ Placeholder synthesis only (need real API)
- AC #4: ⚠️ Pipeline structure ready, streaming skeleton in place (needs real stream impl)
- AC #5: ⚠️ Language parameter supported, actual multi-language synthesis pending real API
- AC #6: ⚠️ Unit tests created but blocked by Jest ESM issue; runtime verification confirms behavior
- AC #7: ⚠️ Cannot verify via automated tests (blocked); manual verification shows no breaking changes

### File List

**Created:**

- `packages/services/agent/src/config.ts` - Centralized environment configuration
- `packages/services/agent/src/criteriaTtsService.ts` - Criteria TTS integration
- `packages/services/agent/src/__tests__/ttsProcessors.test.ts` - Unit tests for TTS pipeline
- `packages/services/agent/src/verify-tts.ts` - Runtime verification script
- `packages/services/agent/src/verify-deepgram.ts` - Runtime verification script for STT
- `packages/services/agent/.env.example` - Environment variable documentation

**Modified:**

- `packages/services/agent/src/pipecatProcessors.ts` - Added processOutgoingAudioPipeline
- `packages/services/agent/src/index.ts` - Exported processOutgoingAudioPipeline
- `packages/services/agent/src/swaramAiService.ts` - Use centralized CONFIG
- `packages/services/agent/src/deepgramSttService.ts` - Use centralized CONFIG

## Change Log

| Date       | Version | Description                                    | Author      |
| :--------- | :------ | :--------------------------------------------- | :---------- |
| 2025-11-05 | 1.0     | Initial implementation - TTS infrastructure    | James (Dev) |
| 2025-11-05 | 1.1     | Fixed lint issues, centralized config complete | James (Dev) |
