# Story 11.1: Fix API Server TypeScript Errors and Port Configuration - Brownfield Fix

## Status

Not Started

## User Story

**As a** developer working on the Civic Voice Assistant platform,
**I want** the API server to compile without TypeScript errors and start without port conflicts,
**So that** I can develop, test, and deploy the application without build failures or runtime errors.

## Story Context

### Existing System Integration

- **Integrates with:** Hono-based API server (`apps/api/src/index.ts`) - the central routing layer for all backend services
- **Technology:** Hono framework, Node.js, TypeScript, Turborepo monorepo
- **Follows pattern:** Existing Hono routing patterns, serverless function patterns used across the API service
- **Touch points:**
  - HTTP server initialization
  - WebSocket connection setup for voice chat
  - API route mounting (reports, agent, admin endpoints)
  - Environment variable configuration in turbo.json
  - Package dependencies in apps/api/package.json

### Current Issues

The API server has critical TypeScript compilation errors that prevent successful builds:

1. **Line 36 - HTTP Server Type Mismatch:**

   ```typescript
   const server = createServer(app.fetch);
   ```

   - `createServer` expects Node.js `RequestListener`, but `app.fetch` is Hono's Request/Response handler
   - Need to use `@hono/node-server` adapter instead

2. **Line 11 - Unused Import:**

   ```typescript
   import { jwt, verify } from "hono/jwt";
   ```

   - `jwt` is imported but never used (only `verify` is used)

3. **Line 39 - Unused Variable:**

   ```typescript
   const { injectWebSocket, upgradeWebSocket } = createNodeWebSocket({ app });
   ```

   - `injectWebSocket` is destructured but never used

4. **Lines 33, 118 - Undeclared Environment Variables:**

   ```typescript
   const SUPABASE_JWT_SECRET =
     process.env.SUPABASE_JWT_SECRET || "YOUR_SUPABASE_JWT_SECRET";
   const port = process.env.PORT || 3001;
   ```

   - `SUPABASE_JWT_SECRET` and `PORT` not listed in turbo.json dependencies

5. **Port Conflicts:**
   - Need to verify and document port assignments across all apps to prevent conflicts

## Acceptance Criteria

### Functional Requirements

1. **API server compiles successfully** with zero TypeScript errors in `apps/api/src/index.ts`
2. **API server starts on port 3001** without conflicts or errors
3. **All existing API routes continue to function** (reports, agent, admin endpoints)
4. **WebSocket connections for voice chat remain operational** after server initialization changes

### Integration Requirements

5. **Existing API endpoint functionality** continues to work unchanged:

   - `/api/v1/reports` - Report submission and retrieval
   - `/api/v1/agent/query` - Agent query endpoint
   - `/api/v1/admin/*` - Admin dashboard endpoints
   - `/api/v1/internal/analyze-report` - Internal report analysis
   - `/ws/voice` - WebSocket voice chat endpoint

6. **Environment variable configuration** follows Turborepo best practices:

   - All environment variables declared in `turbo.json`
   - Proper environment variable scoping for the API app

7. **Port assignments** are documented and conflict-free:
   - API: 3001
   - Web Platform: 3000
   - Admin Web: 3002
   - Mobile: Metro bundler default

### Quality Requirements

8. **Changes are covered by existing integration tests** - all existing tests pass
9. **Code follows Hono and Node.js best practices** for server initialization
10. **No regression in existing functionality** - manual smoke test of all endpoints passes

## Tasks / Subtasks

### Task 1: Fix HTTP Server Initialization (Line 36)

- [ ] **Subtask 1.1:** Install `@hono/node-server` package if not already present

  ```bash
  cd apps/api
  npm install @hono/node-server
  ```

- [ ] **Subtask 1.2:** Update import statement to include `serve` from `@hono/node-server`

  ```typescript
  import { serve } from "@hono/node-server";
  ```

- [ ] **Subtask 1.3:** Replace `createServer(app.fetch)` with proper Hono Node.js adapter

  ```typescript
  // Replace:
  const server = createServer(app.fetch);

  // With appropriate Hono Node.js server pattern
  ```

- [ ] **Subtask 1.4:** Verify WebSocket integration still works with new server setup

### Task 2: Clean Up Unused Imports and Variables

- [ ] **Subtask 2.1:** Remove unused `jwt` import from line 11

  ```typescript
  // Change from:
  import { jwt, verify } from "hono/jwt";

  // To:
  import { verify } from "hono/jwt";
  ```

- [ ] **Subtask 2.2:** Remove unused `injectWebSocket` variable from line 39

  ```typescript
  // Change from:
  const { injectWebSocket, upgradeWebSocket } = createNodeWebSocket({ app });

  // To:
  const { upgradeWebSocket } = createNodeWebSocket({ app });
  ```

- [ ] **Subtask 2.3:** Remove `createServer` import from 'http' if no longer needed

### Task 3: Declare Environment Variables in turbo.json

- [ ] **Subtask 3.1:** Locate the root `turbo.json` file

- [ ] **Subtask 3.2:** Add environment variable declarations for the API app

  ```json
  {
    "pipeline": {
      "dev": {
        "env": [
          "PORT",
          "SUPABASE_JWT_SECRET",
          "SUPABASE_URL",
          "SUPABASE_ANON_KEY"
        ]
      },
      "build": {
        "env": ["SUPABASE_JWT_SECRET"]
      }
    }
  }
  ```

- [ ] **Subtask 3.3:** Verify environment variables are available at runtime

### Task 4: Verify and Document Port Assignments

- [ ] **Subtask 4.1:** Check `apps/api/package.json` dev script for port configuration

- [ ] **Subtask 4.2:** Check `apps/web-platform/package.json` for port configuration

- [ ] **Subtask 4.3:** Check `apps/admin-web/package.json` for port configuration

- [ ] **Subtask 4.4:** Update README or create PORT_ASSIGNMENTS.md if needed:
  ```markdown
  # Port Assignments

  - API Server: 3001
  - Web Platform: 3000
  - Admin Web: 3002
  - Mobile: Metro Bundler (default: 8081)
  ```

### Task 5: Testing and Verification

- [ ] **Subtask 5.1:** Run TypeScript compilation check

  ```bash
  cd apps/api
  npx tsc --noEmit
  ```

- [ ] **Subtask 5.2:** Start API server and verify it starts on port 3001

  ```bash
  npm run dev
  ```

- [ ] **Subtask 5.3:** Test health endpoint

  ```bash
  curl http://localhost:3001/health
  ```

- [ ] **Subtask 5.4:** Test WebSocket voice endpoint connection (manual or automated)

- [ ] **Subtask 5.5:** Run existing API integration tests

  ```bash
  npm run test
  ```

- [ ] **Subtask 5.6:** Verify all services can run concurrently without port conflicts
  ```bash
  cd ../..
  npm run dev
  ```

## Technical Notes

### Integration Approach

The fix involves updating the HTTP server initialization to use the proper Hono Node.js adapter while maintaining all existing functionality including WebSocket support. The changes are minimal and focused on:

1. Using `@hono/node-server` instead of native Node.js `http.createServer()`
2. Properly configuring WebSocket support through Hono's adapter
3. Ensuring environment variables are properly declared for Turborepo's caching

### Existing Pattern Reference

**Current Hono Setup Pattern:**

- Routes are defined using `app.route()` method
- Middleware is applied using `app.use()`
- WebSocket is set up using `@hono/node-ws`

**Server Initialization Pattern (to be fixed):**

```typescript
// Current (incorrect):
import { createServer } from "http";
const server = createServer(app.fetch);

// Should be:
import { serve } from "@hono/node-server";
// Use serve() with proper configuration
```

### Key Constraints

- **Must maintain WebSocket functionality** - Voice chat depends on `/ws/voice` endpoint
- **Must preserve all existing routes** - No breaking changes to API contract
- **Must work with Turborepo** - Environment variable configuration must follow Turbo patterns
- **Must not introduce new dependencies** beyond `@hono/node-server` (which may already be installed)

### Environment Variables Required

```bash
# Runtime (development & production)
PORT=3001
SUPABASE_JWT_SECRET=<your-jwt-secret>
SUPABASE_URL=<your-supabase-url>
SUPABASE_ANON_KEY=<your-anon-key>
```

## Definition of Done

- [x] **Functional requirements met:**

  - [ ] Zero TypeScript compilation errors in `apps/api/src/index.ts`
  - [ ] API server starts successfully on port 3001
  - [ ] All API routes respond correctly
  - [ ] WebSocket voice chat connection works

- [x] **Integration requirements verified:**

  - [ ] All existing endpoints tested and working
  - [ ] Environment variables properly declared in turbo.json
  - [ ] Port assignments documented and verified
  - [ ] No port conflicts when running all services

- [x] **Quality requirements met:**

  - [ ] Existing tests pass
  - [ ] Code follows Hono best practices
  - [ ] No unused imports or variables
  - [ ] TypeScript strict mode compliance

- [x] **Documentation:**
  - [ ] Port assignments documented (if not already)
  - [ ] Environment variables documented in README or .env.example
  - [ ] Code comments updated if needed

## Risk and Compatibility Check

### Minimal Risk Assessment

**Primary Risk:** Changing HTTP server initialization could break WebSocket functionality or prevent server from starting

**Mitigation:**

- Test WebSocket connection immediately after server initialization changes
- Keep the WebSocket setup (`upgradeWebSocket`) intact
- Verify all endpoints work before committing changes
- Test with and without environment variables set

**Rollback:**

- Simple git revert of the changes to `apps/api/src/index.ts`, `package.json`, and `turbo.json`
- No database changes involved
- No breaking API changes

### Compatibility Verification

- [x] **No breaking changes to existing APIs** - Only internal server initialization changes
- [x] **Database changes:** None required
- [x] **UI changes:** None (backend only)
- [x] **Performance impact:** Negligible - same runtime performance expected

## Dev Notes

### Recommended Hono Node.js Server Pattern

Based on Hono documentation, the proper pattern for Node.js server with WebSocket support is:

```typescript
import { Hono } from "hono";
import { serve } from "@hono/node-server";
import { createNodeWebSocket } from "@hono/node-ws";

const app = new Hono();
const { upgradeWebSocket } = createNodeWebSocket({ app });

// Routes and middleware...

// Start server
const port = parseInt(process.env.PORT || "3001");
serve({
  fetch: app.fetch,
  port,
});
```

### Testing Strategy

1. **Unit Level:** TypeScript compilation (`tsc --noEmit`)
2. **Integration Level:** API endpoint smoke tests
3. **System Level:** Full app startup with all services running concurrently

### Estimated Effort

**Time Estimate:** 2-3 hours

- 30 min: Fix server initialization and imports
- 30 min: Update turbo.json configuration
- 30 min: Verify port assignments
- 30-60 min: Testing and verification
- 30 min: Documentation updates

## Related Files

### Primary Files to Modify

- `apps/api/src/index.ts` - Main server file with errors
- `apps/api/package.json` - Add @hono/node-server if needed
- `turbo.json` - Environment variable declarations

### Files to Review (No Changes Expected)

- `apps/api/src/v1/reports/index.ts` - Verify routes still work
- `apps/api/src/v1/agent/query.ts` - Verify agent endpoint works
- `apps/api/src/v1/admin/*.ts` - Verify admin endpoints work
- `apps/web-platform/package.json` - Check port configuration
- `apps/admin-web/package.json` - Check port configuration

### Test Files

- Any existing API integration tests in `apps/api/__tests__/` or `apps/api/src/**/*.test.ts`

## QA Checklist

Before marking this story as complete, verify:

- [ ] `turbo build` succeeds for the entire monorepo
- [ ] `cd apps/api && npm run dev` starts server on port 3001
- [ ] Health check endpoint responds: `GET http://localhost:3001/health`
- [ ] All API v1 endpoints respond correctly
- [ ] WebSocket connection can be established: `ws://localhost:3001/ws/voice?token=<test-token>`
- [ ] All services can run together: `npm run dev` from root
- [ ] No TypeScript errors: `cd apps/api && npx tsc --noEmit`
- [ ] All existing tests pass: `npm run test`
- [ ] Git commit has clear message documenting the fix

## Success Criteria

âœ… **This story is successful when:**

1. Developer can run `turbo build` without any TypeScript errors
2. API server starts cleanly on port 3001 with proper logging
3. All existing API functionality works exactly as before
4. WebSocket voice chat functionality is preserved
5. Environment variables are properly configured for Turborepo
6. Port conflicts are eliminated and documented
7. Code is cleaner with no unused imports or variables

---

**Story Created:** 2025-11-05  
**Epic:** Epic 11 - Codebase Health & Critical Bug Fixes  
**Priority:** High (Blocking)  
**Estimated Effort:** 2-3 hours  
**Dependencies:** None  
**Blocks:** Story 11.2, Story 11.3 (indirectly - need working API for full testing)
