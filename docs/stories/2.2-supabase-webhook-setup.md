# Supabase Webhook Setup for Automatic Report Analysis

This document provides instructions for setting up a Supabase database webhook that automatically triggers AI-powered analysis of civic reports when they are inserted into the database.

## Overview

When a new report is submitted to the `reports` table, we want to:
1. Automatically trigger our NLP analysis service
2. Categorize the report based on its description
3. Assign a priority level (High/Medium/Low)
4. Update the report with the analysis results

## Database Function Setup

First, create a database function that will call our internal API endpoint when a new report is inserted:

```sql
-- Create a function to trigger report analysis
CREATE OR REPLACE FUNCTION trigger_report_analysis()
RETURNS TRIGGER AS $$
DECLARE
    api_url TEXT := 'https://your-api-domain.com/api/v1/internal/analyze-report';
    response_data JSON;
BEGIN
    -- Only trigger for new reports that don't already have a category
    IF TG_OP = 'INSERT' AND NEW.category IS NULL THEN
        -- Make HTTP request to our analysis API
        SELECT content::json INTO response_data
        FROM http_post(
            api_url,
            json_build_object(
                'reportId', NEW.id,
                'description', NEW.description
            )::text,
            'application/json'
        );
        
        -- Log the analysis trigger (optional)
        RAISE NOTICE 'Triggered analysis for report %', NEW.id;
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

## Database Trigger Setup

Create a trigger that calls the function after each insert:

```sql
-- Create trigger to automatically analyze new reports
DROP TRIGGER IF EXISTS reports_analysis_trigger ON reports;

CREATE TRIGGER reports_analysis_trigger
    AFTER INSERT ON reports
    FOR EACH ROW
    EXECUTE FUNCTION trigger_report_analysis();
```

## HTTP Extension Setup

Enable the HTTP extension in Supabase to allow database functions to make HTTP requests:

```sql
-- Enable HTTP extension for making API calls from database functions
CREATE EXTENSION IF NOT EXISTS http;
```

## Alternative: Edge Function Webhook

If the HTTP extension approach doesn't work or you prefer more control, you can create a Supabase Edge Function that handles the webhook:

### 1. Create Edge Function

Create a new file at `supabase/functions/analyze-report/index.ts`:

```typescript
import { serve } from "https://deno.land/std@0.168.0/http/server.ts"

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
}

serve(async (req) => {
  // Handle CORS preflight requests
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders })
  }

  try {
    const { record } = await req.json()
    
    // Only process new reports without existing category
    if (!record.category) {
      // Call our internal analysis API
      const analysisResponse = await fetch('https://your-api-domain.com/api/v1/internal/analyze-report', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          reportId: record.id,
          description: record.description,
        }),
      })

      if (!analysisResponse.ok) {
        throw new Error(`Analysis API returned ${analysisResponse.status}`)
      }

      const analysisResult = await analysisResponse.json()
      
      console.log(`Analysis completed for report ${record.id}:`, analysisResult)
    }

    return new Response(
      JSON.stringify({ success: true }),
      { 
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        status: 200 
      }
    )
  } catch (error) {
    console.error('Error in analyze-report webhook:', error)
    
    return new Response(
      JSON.stringify({ error: error.message }),
      { 
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        status: 500 
      }
    )
  }
})
```

### 2. Deploy Edge Function

```bash
# Deploy the edge function
supabase functions deploy analyze-report

# Get the function URL
supabase functions list
```

### 3. Create Database Webhook

In the Supabase dashboard:

1. Go to Database → Webhooks
2. Create a new webhook with:
   - **Table**: `reports`
   - **Events**: `INSERT`
   - **URL**: `https://your-project-ref.supabase.co/functions/v1/analyze-report`
   - **HTTP Headers**: 
     ```
     Authorization: Bearer YOUR_SERVICE_ROLE_KEY
     Content-Type: application/json
     ```

## Environment Variables

Make sure your API has access to these environment variables:

```env
# Supabase Configuration
SUPABASE_URL=https://your-project-ref.supabase.co
SUPABASE_ANON_KEY=your_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key

# Google Cloud Configuration
GOOGLE_CLOUD_PROJECT_ID=your_project_id
GOOGLE_APPLICATION_CREDENTIALS=path/to/service-account-key.json

# API Configuration
API_URL=https://your-api-domain.com
```

## Testing the Webhook

### 1. Test Manual Report Analysis

First, test the analysis endpoint directly:

```bash
curl -X POST https://your-api-domain.com/api/v1/internal/analyze-report \
  -H "Content-Type: application/json" \
  -d '{
    "reportId": "123e4567-e89b-12d3-a456-426614174000",
    "description": "Large pothole on Main Street causing vehicle damage"
  }'
```

### 2. Test Database Insert

Insert a test report to trigger the webhook:

```sql
INSERT INTO reports (description, photo_url, location, citizen_id)
VALUES (
  'Broken street light at intersection making it dangerous for pedestrians',
  'https://example.com/photo.jpg',
  ST_Point(-74.0060, 40.7128),
  gen_random_uuid()
);
```

### 3. Verify Analysis Results

Check that the report was analyzed and updated:

```sql
SELECT id, description, category, priority, created_at, updated_at
FROM reports
ORDER BY created_at DESC
LIMIT 5;
```

## Monitoring and Logging

### Database Logs

Monitor webhook execution in Supabase:
- Go to Logs → Database
- Filter for webhook-related messages
- Look for any errors in the `trigger_report_analysis` function

### Edge Function Logs

If using Edge Functions:
- Go to Edge Functions → analyze-report
- Check the Logs tab for execution details
- Monitor for any HTTP errors or timeouts

### API Logs

Monitor your API application logs for:
- Incoming analysis requests
- NLP service calls to Google Cloud
- Database update operations
- Error rates and response times

## Security Considerations

1. **API Authentication**: Consider adding API key authentication to your analysis endpoint
2. **Rate Limiting**: Implement rate limiting to prevent abuse
3. **Input Validation**: Ensure robust validation of webhook payloads
4. **Error Handling**: Implement proper error handling and retry logic
5. **Monitoring**: Set up alerts for webhook failures

## Troubleshooting

### Common Issues

1. **HTTP Extension Not Available**: Some Supabase plans may not include the HTTP extension
2. **Network Timeouts**: API calls from database functions have timeout limits
3. **Authentication Errors**: Verify service role keys and API permissions
4. **JSON Parsing Errors**: Ensure proper content-type headers in webhook calls

### Debug Steps

1. Check Supabase logs for webhook execution
2. Verify API endpoint is accessible and responding
3. Test analysis endpoint independently
4. Check environment variable configuration
5. Validate database trigger and function syntax

## Performance Considerations

1. **Async Processing**: Consider using a queue system for heavy analysis workloads
2. **Batch Processing**: Group multiple reports for batch analysis if volume is high
3. **Caching**: Cache analysis results to avoid re-processing similar reports
4. **Timeout Handling**: Set appropriate timeouts for external API calls

This webhook setup ensures that every new civic report is automatically analyzed and categorized, providing immediate value to administrators and improving response times for citizens.