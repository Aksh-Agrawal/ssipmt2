# <!-- Powered by BMADâ„¢ Core -->
# Story 4.4: Agent Responds with Stored Knowledge

## Status
Draft

## Story
**As a** user,
**I want** to ask "why was garbage not picked up?" and receive a relevant explanation from the agent,
**so that** I can get answers to non-real-time civic questions.

## Acceptance Criteria
1. The `agent-service` can identify an `informational_query` intent.
2. When this intent is detected, the service searches the **Live DB** using the logic from the previous story.
3. If one or more relevant articles are found, the `content` of the top-ranked article is used as the agent's response.
4. If no relevant articles are found, a standard fallback message is sent as the response (e.g., "Sorry, I don't have information on that.").

## Tasks / Subtasks
- [ ] In the main `agent-service` logic for the `POST /api/v1/agent/query` endpoint, add the control flow to handle the `informational_query` intent. (AC: #1)
- [ ] If the intent is matched, call the `findArticlesByTags` function with the keywords from the NLP result. (AC: #2)
- [ ] If the search function returns any articles, take the first one from the ranked list. (AC: #3)
- [ ] Format the final API response to be `{ "response": article.content }`. (AC: #3)
- [ ] If the search function returns an empty array, format the final API response to be `{ "response": "Sorry, I don't have information on that right now." }`. (AC: #4)
- [ ] No frontend changes are required for this story.

## Dev Notes
This story connects the knowledge retrieval logic to the user-facing agent API, completing the informational query feature.

- **Simplicity:** For this story, the agent should simply return the content of the single best-matching article. More complex conversational logic (like asking clarifying questions if multiple articles are found) is out of scope for the MVP.
- **Fallback Message:** The quality of the fallback message is important for user experience. It should be polite and manage expectations.

### Testing
- **Backend End-to-End Test:** This is the most important test. Write a full integration test for the `POST /api/v1/agent/query` endpoint.
  1.  Seed the test Redis DB with a known `KnowledgeArticle`.
  2.  Mock the `nlpService` to return an `{ intent: 'informational_query', tags: [...] }` object that will match the seeded article.
  3.  Call the endpoint with a user query.
  4.  Assert that the final HTTP response body is `{ "response": "<content of the seeded article>" }`.
  5.  Create a second test where the mocked `nlpService` returns tags that do not match any seeded articles, and assert that the response body is `{ "response": "<standard fallback message>" }`.

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-10-18 | 1.0 | Initial draft of the story. | Sarah (PO) |
