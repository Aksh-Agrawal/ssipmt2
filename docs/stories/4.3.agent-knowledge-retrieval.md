# <!-- Powered by BMADâ„¢ Core -->
# Story 4.3: Agent Knowledge Retrieval

## Status
Draft

## Story
**As a** developer,
**I want** the `agent-service` to search the **Live DB** for content based on keywords from a user's query,
**so that** it can find relevant informational articles.

## Acceptance Criteria
1. The `agent-service` can extract relevant keywords (tags) from a user's query.
2. The service can search the **Live DB** by finding the intersection of articles associated with the extracted tags.
3. The search function returns a ranked list of the most relevant `KnowledgeArticle` documents.

## Tasks / Subtasks
- [ ] Enhance the `nlpService` to extract key nouns or terms from a user's query to be used as search tags. (AC: #1)
- [ ] In the `agent-service` repository, create a new function `findArticlesByTags(tags: string[])`. (AC: #2)
- [ ] Implement the Redis logic within this function to use `SINTER` to get the intersection of article IDs from the tag sets. (AC: #2)
- [ ] After finding matching IDs, fetch the full data for each article. (AC: #3)
- [ ] Implement a simple ranking algorithm to sort the results (e.g., by number of matching tags or another relevance score). (AC: #3)
- [ ] In the main agent logic, if an `informational_query` intent is detected, call this new search function with the extracted keywords. (AC: #1, #2)

## Dev Notes
This story implements the core search logic that allows the agent to answer non-real-time questions. The effectiveness of the Redis tag intersection strategy is key.

- **Redis Search:** The primary command to use is `SINTER`, which will perform an AND search across multiple tags. This is more precise than `SUNION` (OR search). The repository function should be built around this command.
- **Keyword Extraction:** The quality of the search depends on the quality of the keywords extracted by the `nlpService`. This may need refinement, but a good starting point is to extract all nouns and proper nouns from the user's query.
- **Ranking:** If a query with tags ["garbage", "schedule", "holiday"] matches one article with all three tags and another with only two, the first should be ranked higher. The search function should return a sorted list.
- **No Results:** The function should gracefully handle cases where no articles match the tags and return an empty array.

### Testing
- **Backend Integration Test:** This is the most critical test. Seed a test Redis instance with several articles and tag associations. For example, Article 1 with tags `[a, b]`, Article 2 with tags `[b, c]`, and Article 3 with tags `[a, b, c]`. Then, write tests for the `findArticlesByTags` function:
  - Calling with `[a, b]` should return Article 1 and 3.
  - Calling with `[b, c]` should return Article 2 and 3.
  - Calling with `[a, c]` should return only Article 3.
  - Assert that the ranking logic works as expected.

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-10-18 | 1.0 | Initial draft of the story. | Sarah (PO) |
