# <!-- Powered by BMAD™ Core -->
# Story 1.5: Photo Attachment

## Status
✅ Complete

## Story
**As a** citizen,
**I want** to attach a geo-tagged photo to my report,
**so that** I can provide visual proof of the issue.

## Acceptance Criteria
1. The user can attach a photo to their report by either taking a new one with the camera or selecting one from their device's gallery.
2. After a photo is selected, a thumbnail of it is displayed on the report submission screen.
3. The application captures the device's current GPS coordinates (latitude and longitude) when the photo is attached.
4. The user must be prompted for camera and location permissions if not already granted.

## Tasks / Subtasks
- [x] Add an "Attach Photo" button to the `ReportSubmissionScreen.tsx`. (AC: #1)
- [x] Research and integrate a suitable image picker library (e.g., `react-native-image-picker`). (AC: #1)
- [x] Research and integrate a suitable geolocation library (e.g., `react-native-geolocation-service`). (AC: #3)
- [x] Implement logic to request camera, photo gallery, and location permissions. (AC: #4)
- [x] Add an `Image` component to the screen to display the selected photo's thumbnail. (AC: #2)
- [x] Create state variables to hold the selected image URI and the captured location data. (AC: #2, #3)
- [x] On button press, launch the image picker, allowing the user to choose between camera or gallery. (AC: #1)
- [x] Upon successful image selection, update the state with the image URI and fetch the current geolocation to store in state. (AC: #2, #3)

## Dev Notes
This story adds the crucial data integrity feature of verified, geo-tagged proof. The process should feel seamless to the user.

- **Image Picker Library:** `react-native-image-picker` is a strong candidate as it supports both camera and library access and is well-maintained.
- **Geolocation Library:** `react-native-geolocation-service` is recommended over the built-in React Native one for better accuracy and maintenance.
- **Permissions:** Ensure that `Info.plist` (iOS) and `AndroidManifest.xml` (Android) are updated with clear descriptions for why the app needs camera, photo library, and location permissions. This is critical for user trust and App Store approval.
- **Data Handling:** This story is only concerned with capturing the image URI and location data in the frontend state. The actual file upload and data submission will be handled in the next story (1.6).

### Testing
- **Unit Test:** The `ReportSubmissionScreen` test should be updated to assert that the "Attach Photo" button is rendered.
- **Integration Test:** Mock both the image picker and geolocation libraries. Write a test to simulate a press on the "Attach Photo" button. Verify that the mocked library's launch function is called. Simulate a successful response from both mocks and verify that the `Image` component displays the correct thumbnail and that the location data is correctly stored in the component's state.

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-10-18 | 1.0 | Initial draft of the story. | Sarah (PO) |

## QA Results

### Review Date: 2025-10-31

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Excellent implementation** with comprehensive feature coverage. The photo attachment functionality demonstrates strong technical architecture with proper separation of concerns, robust error handling, and cross-platform compatibility.

### Refactoring Performed

- **File**: `tsconfig.json`
  - **Change**: Added `jsxImportSource: "react"` to compiler options
  - **Why**: Attempted to resolve JSX component type conflicts between React types versions
  - **How**: Provides explicit JSX import source for better type resolution

### Compliance Check

- **Coding Standards**: ✓ **Excellent adherence** - Proper PascalCase for components, camelCase for functions, clear TypeScript interfaces
- **Project Structure**: ✓ **Perfect** - Component correctly placed in `src/features/report/` following established patterns
- **Testing Strategy**: ✓ **Comprehensive** - All dependencies properly mocked, 10 focused test cases covering core functionality
- **All ACs Met**: ✓ **Complete** - All 4 acceptance criteria fully implemented and tested

### Improvements Checklist

- [x] Verified comprehensive permission handling (camera, photo library, location)
- [x] Confirmed proper TypeScript interfaces for PhotoData and LocationData
- [x] Validated cross-platform permission logic (iOS/Android)
- [x] Verified GPS coordinate capture with 6-decimal precision display
- [x] Confirmed proper error handling with user-friendly alerts
- [ ] **TypeScript JSX Type Resolution**: React types version conflict causing JSX component warnings (non-blocking)
- [ ] **Future Enhancement**: Consider adding photo compression for large images
- [ ] **Future Enhancement**: Add EXIF data preservation for forensic integrity

### Security Review

**PASS** - Proper permission handling implemented with clear user prompts. No sensitive data exposure risks identified. Location data captured securely with user consent.

### Performance Considerations

**PASS** - Image picker configured with reasonable constraints (2000x2000 max resolution). Geolocation timeouts properly configured. No memory leaks in useEffect cleanup.

### Files Modified During Review

- `apps/mobile/tsconfig.json` - Added JSX import source configuration

### Gate Status

Gate: **CONCERNS** → docs/qa/gates/1.5-photo-attachment.yml  
Concerns limited to non-functional TypeScript configuration issues that don't impact runtime functionality.

### Recommended Status

**✓ Ready for Done** - All acceptance criteria met with excellent implementation quality. TypeScript type warnings are configuration-related and don't affect functionality.
