# Story 11.3: Verify and Fix Voice Toggle Button in Mobile Agent Screen - Brownfield Fix

## Status

Not Started

## User Story

**As a** citizen using the mobile Civic Voice Assistant,
**I want** to see and use the voice toggle button in the agent chat screen,
**So that** I can interact with the civic information agent using voice instead of typing.

## Story Context

### Existing System Integration

- **Integrates with:** Mobile app AgentChatScreen (`apps/mobile/src/features/agent/AgentChatScreen.tsx`)
- **Technology:** React Native, TypeScript, React Native Paper (Material Design), WebSocket
- **Follows pattern:** Existing React Native Paper IconButton patterns, VoiceService integration
- **Touch points:**
  - AgentChatScreen UI component
  - VoiceService (`apps/mobile/src/services/VoiceService.ts`)
  - WebSocket connection for voice chat
  - IconButton styling and visibility

### Current Implementation

The voice chat functionality is **already implemented** in the code:

1. **Voice Button Exists in Code (Lines 200-209):**

   ```tsx
   <IconButton
     icon={isVoiceChatActive ? "stop" : "microphone"}
     mode="contained"
     size={24}
     onPress={handleVoiceChatPress}
     style={styles.voiceButton}
     iconColor="#fff"
     containerColor={isVoiceChatActive ? "#ff0000" : "#6200ee"}
   />
   ```

2. **Voice Service Integration Present:**

   - `VoiceService.ts` has `startVoiceChat()` and `stopVoiceChat()` methods
   - WebSocket connection logic implemented
   - State management for `isVoiceChatActive` exists

3. **Potential Issues:**
   - Button may not be rendering due to styling issues
   - WebSocket URL might be misconfigured
   - Component layout might hide the button
   - Button might render but be invisible (color/size issues)

### Product Context

Voice interaction is a **core feature** of the Civic Voice Assistant per the PRD:

- "Tap and Speak" interaction paradigm
- Voice-based interface for querying civic information
- Real-time bidirectional audio stream using PipeCat framework
- Story 9.1 already implemented the voice session management

## Acceptance Criteria

### Functional Requirements

1. **Voice toggle button is visible** in AgentChatScreen on app startup

2. **Button displays correct icon** based on state:

   - Microphone icon when inactive
   - Stop icon when voice chat is active

3. **Button changes color** based on state:

   - Purple (#6200ee) when inactive
   - Red (#ff0000) when active

4. **Button responds to touch** and triggers voice chat functionality

### Integration Requirements

5. **WebSocket connection establishes** when voice chat is started:

   - Connects to proper WebSocket endpoint
   - Authentication token passed correctly
   - Connection success/failure handled gracefully

6. **VoiceService integration works** end-to-end:

   - `startVoiceChat()` initiates recording and connection
   - `stopVoiceChat()` properly cleans up resources
   - Audio streaming functions properly

7. **Text input is disabled** during voice chat (existing behavior preserved)

8. **State management works correctly:**
   - `isVoiceChatActive` updates properly
   - UI reflects state changes immediately
   - No race conditions or state inconsistencies

### Quality Requirements

9. **Existing AgentChatScreen tests pass** with any needed updates

10. **No regression in text chat functionality:**

    - Can still type and send messages
    - Messages display correctly
    - Agent responses work as before

11. **Button is accessible** and follows React Native Paper design patterns

## Tasks / Subtasks

### Task 1: Visual Inspection and Layout Verification

- [ ] **Subtask 1.1:** Run mobile app and navigate to AgentChatScreen

  ```bash
  cd apps/mobile
  npm run android
  # or
  npm run ios
  ```

- [ ] **Subtask 1.2:** Visually inspect if voice button is present in the input area

- [ ] **Subtask 1.3:** Check component layout structure:

  - Verify button is in the correct View container
  - Check flex layout isn't hiding the button
  - Verify button is positioned correctly relative to TextInput and Send button

- [ ] **Subtask 1.4:** Use React Native DevTools to inspect component tree

### Task 2: Verify and Fix Button Styling

- [ ] **Subtask 2.1:** Review current button styles (line 301-303):

  ```tsx
  voiceButton: {
    marginRight: 8,
  },
  ```

- [ ] **Subtask 2.2:** Verify IconButton props are correct:

  - `mode="contained"` is valid for IconButton
  - `size={24}` is appropriate
  - Colors are visible against background

- [ ] **Subtask 2.3:** Add any missing style properties if needed:

  ```tsx
  voiceButton: {
    marginRight: 8,
    // Potentially add:
    // alignSelf: 'center',
    // or other layout/visibility properties
  },
  ```

- [ ] **Subtask 2.4:** Test different screen sizes to ensure button doesn't overflow or hide

### Task 3: WebSocket Configuration Verification

- [ ] **Subtask 3.1:** Review WebSocket URL in `handleVoiceChatPress` (line 106):

  ```tsx
  const websocketUrl = "ws://localhost:3000/ws/voice";
  ```

- [ ] **Subtask 3.2:** Update WebSocket URL to use environment variable or config:

  ```tsx
  const websocketUrl = process.env.EXPO_PUBLIC_API_URL
    ? `${process.env.EXPO_PUBLIC_API_URL.replace("http", "ws")}/ws/voice`
    : "ws://localhost:3001/ws/voice"; // Note: API is on port 3001
  ```

- [ ] **Subtask 3.3:** Verify WebSocket endpoint exists in API server (from Story 11.1)

- [ ] **Subtask 3.4:** Test WebSocket connection with authentication token

- [ ] **Subtask 3.5:** Add error handling for connection failures:
  ```tsx
  if (!started) {
    Alert.alert("Connection Error", "Could not connect to voice service");
  }
  ```

### Task 4: VoiceService Integration Testing

- [ ] **Subtask 4.1:** Review VoiceService implementation:

  - Check `startVoiceChat()` method
  - Check `stopVoiceChat()` method
  - Verify WebSocket message handling

- [ ] **Subtask 4.2:** Add logging to VoiceService for debugging:

  ```typescript
  console.log("Starting voice chat with URL:", websocketBaseUrl);
  ```

- [ ] **Subtask 4.3:** Test voice recording permissions on both platforms:

  - Android: Microphone permission
  - iOS: Microphone permission via Info.plist

- [ ] **Subtask 4.4:** Verify audio recording starts when voice chat begins

- [ ] **Subtask 4.5:** Verify audio playback works for agent responses

### Task 5: State Management and UI Updates

- [ ] **Subtask 5.1:** Verify `isVoiceChatActive` state updates correctly:

  ```tsx
  console.log("Voice chat active:", isVoiceChatActive);
  ```

- [ ] **Subtask 5.2:** Test button icon changes when state updates

- [ ] **Subtask 5.3:** Test button color changes when state updates

- [ ] **Subtask 5.4:** Verify text input disables/enables properly:

  ```tsx
  editable={!isVoiceChatActive}
  ```

- [ ] **Subtask 5.5:** Verify send button disables during voice chat:
  ```tsx
  disabled={inputText.trim() === '' || isLoading || isVoiceChatActive}
  ```

### Task 6: Testing and Verification

- [ ] **Subtask 6.1:** Manual test on Android device/emulator:

  - Voice button visible
  - Voice button clickable
  - Voice chat starts/stops
  - Audio recording works

- [ ] **Subtask 6.2:** Manual test on iOS device/simulator:

  - Voice button visible
  - Voice button clickable
  - Voice chat starts/stops
  - Audio recording works

- [ ] **Subtask 6.3:** Update AgentChatScreen.test.tsx if needed:

  ```typescript
  it("should render voice toggle button", () => {
    const { getByA11yLabel } = render(<AgentChatScreen />);
    const voiceButton = getByA11yLabel("microphone");
    expect(voiceButton).toBeTruthy();
  });
  ```

- [ ] **Subtask 6.4:** Run test suite:

  ```bash
  cd apps/mobile
  npm run test
  ```

- [ ] **Subtask 6.5:** Test regression scenarios:
  - Text chat still works
  - Sending messages works
  - Agent responses display
  - Map view still functions

## Technical Notes

### Integration Approach

This story is primarily **verification and debugging** rather than new implementation:

1. **Confirm button renders** - Check if layout or styling is hiding it
2. **Fix WebSocket URL** - Ensure it points to correct API endpoint (port 3001)
3. **Test end-to-end** - Verify voice chat actually works
4. **Add visual tests** - Ensure button visibility is tested

### Existing Pattern Reference

**Current Implementation (AgentChatScreen.tsx lines 93-108):**

```tsx
const handleVoiceChatPress = async () => {
  if (isVoiceChatActive) {
    await voiceService.stopVoiceChat();
    setIsVoiceChatActive(false);
  } else {
    const websocketUrl = "ws://localhost:3000/ws/voice";
    const started = await voiceService.startVoiceChat(websocketUrl);
    setIsVoiceChatActive(started);
  }
};
```

**Input Container Layout (lines 195-227):**

```tsx
<View style={styles.inputContainer}>
  <IconButton icon="microphone" ... />  {/* Voice button */}
  <TextInput ... />                      {/* Text input */}
  <IconButton icon="send" ... />         {/* Send button */}
</View>
```

### Key Constraints

- **Must not break text chat** - Primary interaction method
- **Must handle permissions** - Microphone access required
- **Must work offline gracefully** - Handle WebSocket connection failures
- **Must follow React Native Paper patterns** - Consistent with app design

### WebSocket Configuration

**Correct WebSocket URL:**

```typescript
// Development
ws://localhost:3001/ws/voice?token=<jwt-token>

// Production (example)
wss://api.yourapp.com/ws/voice?token=<jwt-token>
```

**Environment Variable Setup:**

```bash
# .env or app.config.js
EXPO_PUBLIC_API_URL=http://localhost:3001
```

### VoiceService Dependencies

From `VoiceService.ts`:

- `react-native-nitro-sound` - AudioRecorder, AudioPlayer
- WebSocket connection
- Base64 audio encoding
- Permission handling (PermissionsAndroid)

## Definition of Done

- [x] **Functional requirements met:**

  - [ ] Voice button visible in AgentChatScreen
  - [ ] Button displays correct icon based on state
  - [ ] Button changes color based on state
  - [ ] Button triggers voice chat functionality

- [x] **Integration requirements verified:**

  - [ ] WebSocket connects successfully
  - [ ] VoiceService integration works end-to-end
  - [ ] Text input disables during voice chat
  - [ ] State management works correctly

- [x] **Quality requirements met:**

  - [ ] Tests updated and passing
  - [ ] No regression in text chat
  - [ ] Button follows design patterns

- [x] **Platform testing:**
  - [ ] Works on Android
  - [ ] Works on iOS
  - [ ] Permissions handled correctly
  - [ ] Error states handled gracefully

## Risk and Compatibility Check

### Minimal Risk Assessment

**Primary Risk:** WebSocket connection fails or voice recording doesn't work on actual devices

**Mitigation:**

- Test on real devices, not just emulators
- Add comprehensive error handling and user feedback
- Graceful degradation if voice chat unavailable
- Keep text chat as primary interaction method

**Rollback:**

- Voice chat is an enhancement; text chat is primary
- Can disable voice button if critical issues found
- Simple git revert if needed
- No data or API contract changes

### Compatibility Verification

- [x] **No breaking changes to existing APIs** - Uses existing WebSocket endpoint
- [x] **Database changes:** None required
- [x] **UI changes:** Only visibility/bug fix, no new functionality
- [x] **Performance impact:** Minimal (only when voice chat active)

## Dev Notes

### Debugging Checklist

If button is not visible:

1. **Check Component Tree:**

   ```bash
   # Use React Native Debugger or Flipper
   # Inspect element hierarchy
   ```

2. **Check Console Logs:**

   ```typescript
   console.log("Rendering voice button");
   console.log("isVoiceChatActive:", isVoiceChatActive);
   ```

3. **Check Styling:**

   ```typescript
   // Temporarily add obvious styling to debug
   voiceButton: {
     marginRight: 8,
     backgroundColor: 'red', // TEMPORARY - for debugging
     borderWidth: 2,
     borderColor: 'yellow',
   }
   ```

4. **Verify IconButton Import:**
   ```typescript
   import { IconButton } from "react-native-paper";
   ```

### Common Issues and Solutions

| Issue                          | Likely Cause             | Solution                       |
| ------------------------------ | ------------------------ | ------------------------------ |
| Button not visible             | Flex layout hiding it    | Adjust flexbox properties      |
| Button not clickable           | Z-index or overlay issue | Check View hierarchy           |
| WebSocket fails                | Wrong URL/port           | Update to port 3001            |
| No audio permission            | Permission not requested | Check VoiceService permissions |
| Button renders but no function | Handler not firing       | Add console.log to debug       |

### Testing Strategy

1. **Visual Testing:** Manually verify button presence
2. **Functional Testing:** Test voice chat start/stop
3. **Integration Testing:** Test WebSocket connection
4. **Permission Testing:** Test microphone access
5. **Regression Testing:** Verify text chat still works

### Estimated Effort

**Time Estimate:** 2-3 hours

- 30 min: Visual inspection and layout debugging
- 30 min: WebSocket URL configuration fix
- 1 hour: End-to-end voice chat testing (both platforms)
- 30 min: Test updates and verification
- 30 min: Documentation and cleanup

## Related Files

### Files to Modify (Potentially)

- `apps/mobile/src/features/agent/AgentChatScreen.tsx` - **PRIMARY** (WebSocket URL fix, styling)
- `apps/mobile/src/features/agent/AgentChatScreen.test.tsx` - **TESTS** (add visibility test)
- `apps/mobile/src/services/VoiceService.ts` - **OPTIONAL** (improved error handling)

### Files to Review (No Changes Expected)

- `apps/mobile/app.config.js` - Environment variables
- `apps/mobile/android/app/src/main/AndroidManifest.xml` - Microphone permissions
- `apps/mobile/ios/CivicVoiceApp/Info.plist` - Microphone permissions

### Configuration Files

- `.env` or `app.config.js` - API URL configuration

## QA Checklist

Before marking this story as complete, verify:

- [ ] Voice button visible when AgentChatScreen loads
- [ ] Button icon is microphone when inactive
- [ ] Button icon is stop when active
- [ ] Button color is purple when inactive
- [ ] Button color is red when active
- [ ] Tapping button starts voice chat (with permissions)
- [ ] WebSocket connection establishes successfully
- [ ] Audio recording starts when voice chat active
- [ ] Text input disables during voice chat
- [ ] Send button disables during voice chat
- [ ] Tapping button again stops voice chat
- [ ] Text input re-enables after voice chat stops
- [ ] Works on Android device/emulator
- [ ] Works on iOS device/simulator
- [ ] Tests pass: `npm run test`
- [ ] No regression in text chat functionality

## Success Criteria

âœ… **This story is successful when:**

1. Voice toggle button is clearly visible in AgentChatScreen
2. Button displays correct icon and color based on state
3. Button successfully starts and stops voice chat
4. WebSocket connection works reliably
5. Voice recording and playback function properly
6. Text chat continues to work normally
7. All tests pass
8. Tested on both iOS and Android

---

**Story Created:** 2025-11-05  
**Epic:** Epic 11 - Codebase Health & Critical Bug Fixes  
**Priority:** Medium (Feature Completion)  
**Estimated Effort:** 2-3 hours  
**Dependencies:** Story 11.1 (API server must be working for WebSocket)  
**Blocks:** None
