# <!-- Powered by BMADâ„¢ Core -->
# Story 1.6: Report Submission Service

## Status
Draft

## Story
**As a** developer,
**I want** a backend endpoint that saves report data to the Complaints DB,
**so that** user-submitted reports are persisted and can be tracked.

## Acceptance Criteria
1. A `POST /api/v1/reports` endpoint is created in the `api` application.
2. The endpoint accepts a payload containing the report description, a photo URL, and location data.
3. The service saves the report data to the `reports` table in the PostgreSQL **Complaints DB**.
4. The service returns a `201 Created` status with the unique tracking ID of the new report.
5. The frontend `ReportSubmissionScreen` is updated to send the captured data to this endpoint.

## Tasks / Subtasks

### Backend
- [ ] In the `apps/api` package, create a route handler for `POST /api/v1/reports`. (AC: #1)
- [ ] Implement input validation (e.g., using Zod) for the request body to ensure it matches the expected payload. (AC: #2)
- [ ] In the `packages/services/reporting` package, create a `submitReport` function that contains the core business logic. (AC: #3)
- [ ] Implement the `reportRepository.create` function to insert the validated data into the `reports` table in the Complaints DB, following the defined schema. (AC: #3)
- [ ] Ensure the API response returns a `201` status and a JSON body with the `trackingId` from the newly created database record. (AC: #4)

### Frontend
- [ ] Add a "Submit" button to the `ReportSubmissionScreen.tsx`. (AC: #5)
- [ ] Create a `reportService.ts` file in `apps/mobile/src/services/`. (AC: #5)
- [ ] Implement a `submitReport` function in the service. This function will be responsible for uploading the photo to storage (e.g., Supabase Storage) and then sending the report data (description, photo URL, location) to the `POST /api/v1/reports` endpoint. (AC: #5)
- [ ] Connect the "Submit" button's `onPress` event to call the `reportService.submitReport` function with the data from the component's state. (AC: #5)

## Dev Notes
This story connects the frontend data capture to the backend persistence layer. A key challenge is handling the file upload before creating the report record.

- **Backend Framework:** Use Hono within the Vercel Serverless Function environment as defined in the architecture.
- **Database Interaction:** All database calls must go through the repository pattern (`reportRepository`) to abstract the data access logic.
- **File Storage:** Use Supabase Storage. A recommended pattern is for the client to request a signed upload URL from the backend to upload the file directly. This offloads the work from the serverless function.
- **Data Models:** The payload and database record must adhere strictly to the `Report` interface defined in `packages/shared-types`.
- **Error Handling:** The endpoint should return appropriate HTTP status codes for invalid input (`400`) or server errors (`500`).

### Testing
- **Backend Integration Test (Supertest):** Write a test that sends a valid payload to the `POST /api/v1/reports` endpoint. Mock the database and verify that the service attempts to insert the correct data and returns a `201` status with a tracking ID.
- **Frontend Integration Test (RNTL):** Mock the `reportService`. Populate the `ReportSubmissionScreen` with state data (text, image URI, location). Simulate a press on the "Submit" button and assert that `reportService.submitReport` is called with the correct arguments.

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-10-18 | 1.0 | Initial draft of the story. | Sarah (PO) |
