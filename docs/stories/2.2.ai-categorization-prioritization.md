# <!-- Powered by BMADâ„¢ Core -->
# Story 2.2: AI-Powered Categorization & Prioritization

## Status
Draft

## Story
**As a** developer,
**I want** a service that automatically analyzes new reports in the Complaints DB to assign a category and priority,
**so that** admins see an organized and triaged list.

## Acceptance Criteria
1. When a new report is inserted into the `reports` table, an asynchronous process is triggered.
2. The process sends the report's description text to an external NLP service for analysis.
3. The process determines an appropriate `category` (e.g., "Pothole", "Waste Management") and `priority` (e.g., "Low", "Medium", "High") based on the analysis.
4. The `category` and `priority` fields of the new report record are updated in the **Complaints DB** with the results of the analysis.

## Tasks / Subtasks
- [ ] Set up a Supabase Database Webhook or PostgreSQL Function to trigger on new row insertions in the `reports` table. This trigger should invoke a new serverless function. (AC: #1)
- [ ] Create a new, internal-only serverless function (e.g., `POST /api/v1/internal/analyze-report`) to handle the analysis logic. (AC: #1)
- [ ] In the analysis function, securely access the NLP service API key from environment variables. (AC: #2)
- [ ] Implement the logic to call the external NLP service (e.g., Google Cloud Natural Language API) with the report's description text. (AC: #2)
- [ ] Implement a mapping function to translate the results from the NLP service into the project's defined `category` and `priority` enums. (AC: #3)
- [ ] Implement the logic to use the Supabase client to `UPDATE` the report row in the **Complaints DB** with the new category and priority. (AC: #4)
- [ ] Add robust error handling to the analysis function to log failures (e.g., if the NLP service is unavailable) without crashing the process. (AC: #1-4)

## Dev Notes
This story implements a critical piece of the automation that provides value to the city authorities. The process must be asynchronous to avoid delaying the initial report submission for the user.

- **Trigger Mechanism:** A Supabase Database Webhook is the recommended approach. It provides a clean, event-driven way to invoke a serverless function without modifying the database schema with custom functions.
- **NLP Service:** The architecture specifies using an external service like the Google Cloud Natural Language API (`docs/architecture/7-external-apis.md`). The developer will need to focus on the `classifyText` or `analyzeEntities` methods.
- **Idempotency:** The trigger mechanism should ideally be idempotent or the handler logic should be prepared to handle potential duplicate events to avoid re-analyzing a report.
- **Data Models:** The update operation will populate the `category` and `priority` columns defined in the `reports` table schema (`docs/architecture/9-database-schema.md`) and the `Report` type in `packages/shared-types`.

### Testing
- **Unit Test:** Create a unit test for the mapping logic that translates NLP API responses into the system's `category` and `priority` enums. Mock the NLP response and assert that the output is correct.
- **Integration Test:** Write an integration test for the `analyze-report` serverless function itself. Invoke it with a sample report payload, mock the NLP service API call, and mock the database client. Verify that the database client's `update` method is called with the correct `id`, `category`, and `priority`.

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-10-18 | 1.0 | Initial draft of the story. | Sarah (PO) |
