# <!-- Powered by BMADâ„¢ Core -->
# Story 3.4: Basic Query Processing (NLP)

## Status
Draft

## Story
**As a** developer,
**I want** the `agent-service` to use an NLP service to understand basic user questions about traffic,
**so that** it can determine the user's intent.

## Acceptance Criteria
1. A public endpoint `POST /api/v1/agent/query` is created to receive user queries.
2. The `agent-service` is integrated with an external NLP service (e.g., Google Cloud Natural Language).
3. The service can identify a "check_traffic" intent from various user phrases (e.g., "how is traffic?", "is the road blocked?").
4. The service can extract location entities (e.g., "the station", "downtown") from the user's query.

## Tasks / Subtasks
- [ ] Create the public API endpoint `POST /api/v1/agent/query` in the `apps/api` package. (AC: #1)
- [ ] Obtain API credentials for the chosen NLP service (Google Cloud Natural Language API as per architecture docs). (AC: #2)
- [ ] Add the NLP API key to the backend `.env` configuration. (AC: #2)
- [ ] In `packages/services/agent`, create a new `nlpService.ts` file.
- [ ] Implement a function `processQuery(text)` in `nlpService.ts` that calls the NLP service's `analyzeEntities` and/or `classifyText` endpoints. (AC: #2)
- [ ] Implement logic to parse the NLP response to determine if the intent is `check_traffic`. (AC: #3)
- [ ] Implement logic to extract location-based entities from the NLP response. (AC: #4)
- [ ] The main agent service logic should call `processQuery` and have a placeholder to later route to the `trafficService` if the intent matches. (AC: #3)

## Dev Notes
This story introduces AI-based logic to the agent. The goal is not to build a complex conversational model, but to perform simple intent and entity recognition.

- **NLP Service:** The architecture specifies the Google Cloud Natural Language API (`docs/architecture/7-external-apis.md`). The `analyzeEntities` method will be key for identifying locations mentioned in the query. For intent recognition, `classifyText` could be used with custom training, or a simpler keyword-based approach could be used for this initial story.
- **API Endpoint:** This is the primary public endpoint for all user interaction with the agent.
- **Fallback:** The service must have a default response or behavior for when the NLP service cannot determine a clear intent. For this story, it can simply be a `null` or `unknown_intent` response.

### Testing
- **Integration Test (NLP Service):** Write a test for the `processQuery` function. Use `nock` to mock the NLP API. For a given input like "How is traffic to the airport?", provide a mock API response. Assert that your function correctly parses this response and returns an object like `{ intent: 'check_traffic', entities: { location: 'airport' } }`.
- **Integration Test (Agent Endpoint):** Write a test for the `POST /api/v1/agent/query` endpoint. Mock the `nlpService` itself. When the endpoint is called with a query, assert that the `nlpService.processQuery` function is called with the correct text.

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-10-18 | 1.0 | Initial draft of the story. | Sarah (PO) |
