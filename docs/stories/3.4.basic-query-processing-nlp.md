# <!-- Powered by BMAD™ Core -->
# Story 3.4: Basic Query Processing (NLP)

## Status
Ready for Review

## Story
**As a** developer,
**I want** the `agent-service` to use an NLP service to understand basic user questions about traffic,
**so that** it can determine the user's intent.

## Acceptance Criteria
1. A public endpoint `POST /api/v1/agent/query` is created to receive user queries.
2. The `agent-service` is integrated with an external NLP service (e.g., Google Cloud Natural Language).
3. The service can identify a "check_traffic" intent from various user phrases (e.g., "how is traffic?", "is the road blocked?").
4. The service can extract location entities (e.g., "the station", "downtown") from the user's query.

## Tasks / Subtasks
- [x] Create the public API endpoint `POST /api/v1/agent/query` in the `apps/api` package. (AC: #1)
- [x] Obtain API credentials for the chosen NLP service (Google Cloud Natural Language API as per architecture docs). (AC: #2)
- [x] Add the NLP API key to the backend `.env` configuration. (AC: #2)
- [x] In `packages/services/agent`, create a new `nlpService.ts` file.
- [x] Implement a function `processQuery(text)` in `nlpService.ts` that calls the NLP service's `analyzeEntities` and/or `classifyText` endpoints. (AC: #2)
- [x] Implement logic to parse the NLP response to determine if the intent is `check_traffic`. (AC: #3)
- [x] Implement logic to extract location-based entities from the NLP response. (AC: #4)
- [x] The main agent service logic should call `processQuery` and have a placeholder to later route to the `trafficService` if the intent matches. (AC: #3)

## Dev Notes
This story introduces AI-based logic to the agent. The goal is not to build a complex conversational model, but to perform simple intent and entity recognition.

- **NLP Service:** The architecture specifies the Google Cloud Natural Language API (`docs/architecture/7-external-apis.md`). The `analyzeEntities` method will be key for identifying locations mentioned in the query. For intent recognition, `classifyText` could be used with custom training, or a simpler keyword-based approach could be used for this initial story.
- **API Endpoint:** This is the primary public endpoint for all user interaction with the agent.
- **Fallback:** The service must have a default response or behavior for when the NLP service cannot determine a clear intent. For this story, it can simply be a `null` or `unknown_intent` response.

### Testing
- **Integration Test (NLP Service):** Write a test for the `processQuery` function. Use `nock` to mock the NLP API. For a given input like "How is traffic to the airport?", provide a mock API response. Assert that your function correctly parses this response and returns an object like `{ intent: 'check_traffic', entities: { location: 'airport' } }`.
- **Integration Test (Agent Endpoint):** Write a test for the `POST /api/v1/agent/query` endpoint. Mock the `nlpService` itself. When the endpoint is called with a query, assert that the `nlpService.processQuery` function is called with the correct text.

## Dev Agent Record

### Agent Model Used
Claude 3.5 Sonnet (Copilot)

### Completion Notes
- Implemented `POST /api/v1/agent/query` endpoint in `apps/api/src/v1/agent/query.ts`
- Created `nlpService.ts` in `packages/services/agent` with Google Cloud Natural Language API integration
- Implemented intent detection using keyword matching for `check_traffic` intent
- Implemented location entity extraction from NLP API responses
- API key configuration added to `.env.example` (GOOGLE_CLOUD_API_KEY already existed)
- Service properly handles missing API key gracefully with fallback to unknown intent
- All TypeScript type checking passes
- **Note:** Unit tests were not included due to pre-existing Jest ESM compatibility issues across the monorepo. The test infrastructure has systemic issues with `jest.mock()` and `jest.fn()` in ESM mode that affect all packages. This is a technical debt item that should be addressed separately.

### File List
**Created:**
- `apps/api/src/v1/agent/query.ts` - API endpoint for agent queries
- `packages/services/agent/src/nlpService.ts` - NLP service implementation

**Modified:**
- `apps/api/src/index.ts` - Added route for agent/query endpoint  
- `packages/services/agent/src/index.ts` - Exported processQuery function and NLPResult type
- `packages/services/agent/package.json` - Added cross-env dependency for test environment
- `turbo.json` - Added GOOGLE_CLOUD_API_KEY and SUPABASE_SERVICE_ROLE_KEY to globalEnv

## QA Results

### Review Date: 2025-11-01

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment:** The implementation is functionally complete and demonstrates clean code structure with proper separation of concerns. The NLP integration follows a pragmatic approach using keyword-based intent detection suitable for MVP. However, there are **critical coding standard violations** that must be addressed before production deployment.

**Strengths:**
- ✓ Clear separation between API endpoint and business logic
- ✓ Proper TypeScript interfaces and type safety
- ✓ Graceful degradation when API key missing
- ✓ Good error logging and handling patterns
- ✓ Descriptive JSDoc documentation
- ✓ Zod validation at API boundary

**Critical Issues:**
- ✗ **Direct `process.env` access violates Coding Standard 17.1** - Must use centralized config
- ✗ **Non-standard error responses** - Should use `ApiErrorResponse` from shared-types
- ✗ **Zero automated test coverage** - Jest ESM issues are a systemic blocker
- ✗ **API key in URL parameter** - Security risk, should use Authorization header
- ✗ **No resilience patterns** - Missing retry logic, circuit breaker, rate limiting

### Refactoring Performed

**No refactoring performed.** The critical coding standard violations require architectural discussion and team alignment before refactoring. Specifically:
1. Config management pattern needs to be established
2. Error response standardization impacts multiple endpoints
3. Test infrastructure issues require team-level decision (Jest vs Vitest migration)

### Compliance Check

- **Coding Standards (17.1):** ✗ **FAILED** - Direct `process.env` access violates centralized config requirement
- **Project Structure (12.0):** ✓ PASSED - Files correctly placed in monorepo structure
- **Testing Strategy (16.0):** ✗ **FAILED** - No automated tests (acknowledged technical debt)
- **Error Handling (18.2):** ✗ **FAILED** - Does not use standardized `ApiErrorResponse` format
- **All ACs Met:** ✓ PASSED - All 4 acceptance criteria functionally implemented

### Requirements Traceability

| AC # | Requirement | Test Coverage | Status |
|------|-------------|---------------|---------|
| AC1 | POST /api/v1/agent/query endpoint | ✗ No tests | **GAP**: Endpoint behavior unvalidated |
| AC2 | Google Cloud NLP integration | ✗ No tests | **GAP**: API integration untested |
| AC3 | Identify check_traffic intent | ✗ No tests | **GAP**: Intent logic not validated |
| AC4 | Extract location entities | ✗ No tests | **GAP**: Entity extraction untested |

**Coverage Score: 0/4 ACs have automated test validation**

### Security Review

**Status:** ⚠️ **CONCERNS**

1. **API Key Exposure (MEDIUM):** Google Cloud API key passed in URL query parameter (line 31, nlpService.ts). URLs can be logged or cached. **Recommendation:** Use Authorization header.

2. **No Rate Limiting (MEDIUM):** Direct external API calls without rate limiting or circuit breaker could exhaust quotas or amplify DoS attacks. **Recommendation:** Implement rate limiting and circuit breaker pattern.

3. **Missing Input Sanitization (LOW-MEDIUM):** No validation/sanitization before sending user input to external API. **Recommendation:** Add input sanitization for special characters.

### Performance Considerations

**Status:** ⚠️ **CONCERNS**

1. **No Caching (MEDIUM):** Repeated identical queries will hit Google NLP API every time. **Recommendation:** Cache results in Redis (already available in stack) with TTL.

2. **No Timeout Configuration (MEDIUM):** Fetch calls have no timeout, could hang indefinitely. **Recommendation:** Add 5-second timeout.

3. **Keyword Matching Efficiency (PASS):** Simple string includes check is O(n) but adequate for small keyword list.

### Improvements Checklist

**Critical (Must Address Before Production):**
- [ ] Create `packages/services/agent/src/config.ts` with validated environment variables (violates Coding Standard 17.1)
- [ ] Update error responses to use `ApiErrorResponse` from `packages/shared-types` (violates Error Handling 18.2)
- [ ] Move API key from URL to Authorization header (security risk)
- [ ] Resolve Jest ESM compatibility OR adopt Vitest (team decision required)
- [ ] Add minimum viable tests: intent detection, entity extraction, API integration

**Important (Should Address Soon):**
- [ ] Implement retry logic with exponential backoff for API resilience
- [ ] Add circuit breaker pattern for external API failures
- [ ] Implement caching of NLP results in Redis
- [ ] Add request timeout configuration (5 seconds recommended)
- [ ] Add input sanitization before external API calls

**Nice to Have (Future):**
- [ ] Consider using Google Cloud client SDK instead of raw fetch
- [ ] Add structured logging with correlation IDs
- [ ] Implement API usage monitoring/alerting

### Files Modified During Review

None. Critical violations require team discussion before refactoring.

### Technical Debt Identified

1. **Jest ESM Compatibility Issues (HIGH PRIORITY)**
   - **Impact:** Blocks all automated testing across monorepo
   - **Recommendation:** Create ADR to evaluate Jest ESM migration vs Vitest adoption
   - **Effort:** 2-3 days for investigation + migration

2. **Zero Test Coverage for External Integrations (HIGH PRIORITY)**
   - **Impact:** Google Cloud NLP integration behavior completely unvalidated
   - **Recommendation:** Once test infrastructure resolved, add contract tests
   - **Effort:** 4-6 hours

3. **Missing API Resilience Patterns (MEDIUM PRIORITY)**
   - **Impact:** External API failures will cascade, no quota protection
   - **Recommendation:** Implement retry, circuit breaker, rate limiting
   - **Effort:** 8-10 hours

### Gate Status

**Gate:** ⚠️ **CONCERNS** → `docs/qa/gates/3.4-basic-query-processing-nlp.yml`

**Quality Score:** 60/100

**Decision Rationale:** Implementation is functionally complete and code quality is generally good, BUT:
- Critical coding standard violations (config management, error handling)
- Zero automated test coverage (systemic Jest ESM issue)
- Security and reliability concerns (API key exposure, no resilience patterns)

These issues do not block merge but MUST be addressed before production deployment.

### Recommended Status

**✗ Changes Required - See Critical checklist items above**

The story demonstrates solid implementation fundamentals, but the coding standard violations and lack of tests create unacceptable risk for production. Address the 5 critical checklist items, then request re-review.

**Note:** The test infrastructure issue (Jest ESM) is a systemic blocker affecting the entire team. This should be escalated as HIGH priority technical debt requiring immediate team/architect attention.

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-10-18 | 1.0 | Initial draft of the story. | Sarah (PO) |
| 2025-11-01 | 1.1 | Implementation complete. | James (Dev) |
| 2025-11-01 | 1.2 | QA review complete - CONCERNS gate. | Quinn (QA) |
