# Story 9.2: Multilingual Speech-to-Text with Deepgram & SARVAM AI

**User Story:**
As a user,
I want to speak my queries in multiple languages and have them accurately converted to text,
So that the agent can understand me.

**Story Context:**

- **Integrates with:** The PipeCat audio stream established in Story 1 and the `agent-service`.
- **Technology:** Deepgram STT, SARVAM AI, and the existing PipeCat integration.
- **Follows pattern:** The existing microservices architecture and the event-driven nature of the PipeCat pipeline.
- **Touch points:** This story adds new processors to the `agent-service`'s PipeCat pipeline to handle STT and language detection.

**Acceptance Criteria:**

1.  The `agent-service` pipeline processes the incoming audio stream from PipeCat with Deepgram STT.
2.  SARVAM AI is used to detect the language of the user's speech.
3.  The Deepgram STT service is configured to use the language detected by SARVAM AI for transcription.
4.  The transcribed text is accurately passed to the agent's core logic for processing.
5.  The system correctly transcribes speech in all supported languages (English, Hindi, Chhattisgarhi).
6.  The integration is covered by appropriate tests.
7.  No regression in existing functionality is verified.

**Technical Notes:**

- **Integration Approach:** Add Deepgram STT and SARVAM AI processors to the PipeCat pipeline within the `agent-service`. The SARVAM AI processor will run first to detect the language, and its output will configure the Deepgram STT processor.
- **Existing Pattern Reference:** This builds directly on the PipeCat pipeline pattern established in the previous story.
- **Key Constraints:** The combined latency of language detection and transcription should be low enough to feel like a real-time conversation. API keys for Deepgram and SARVAM AI must be managed securely.

**Minimal Risk Assessment:**

- **Primary Risk:** The accuracy and latency of Deepgram STT and SARVAM AI's language detection, especially for less common dialects or noisy environments.
- **Mitigation:** Conduct extensive testing with diverse audio samples and accents in all supported languages. Implement fallback mechanisms (e.g., default to English if language detection fails).
- **Rollback:** The STT and language detection components can be disabled within the PipeCat pipeline, allowing the system to revert to a text-only input or a simpler STT if issues arise.

**Compatibility Verification:**

- [x] No breaking changes to existing APIs.
- [x] Database changes (if any) are additive only. (No DB changes expected for this story).
- [x] UI changes follow existing design patterns. (No direct UI changes for this story, but the transcribed text will be displayed).
- [x] Performance impact is negligible.

## Dev Agent Record

### Tasks / Subtasks Checkboxes

- [ ] **Task 1: Configure API Keys for External Services.**
  - [x] Subtask 1.1: Add `DEEPGRAM_API_KEY` and `SARVAM_AI_API_KEY` to the environment configuration for the `agent-service`.
  - [ ] Subtask 1.2: Update the service configuration to securely load and provide these keys.
- [x] **Task 2: Integrate SARVAM AI for Language Detection.**
  - [x] Subtask 2.1: Create a new `SARVAMAiService.ts` within `packages/services/agent/src/`.
  - [x] Subtask 2.2: Implement a function to interact with the SARVAM AI language detection endpoint.
  - [x] Subtask 2.3: Add a placeholder for the SARVAM AI processor in the PipeCat pipeline.
- [x] **Task 3: Integrate Deepgram for Speech-to-Text (STT).**
  - [x] Subtask 3.1: Create a new `deepgramSttService.ts` within `packages/services/agent/src/`.
  - [x] Subtask 3.2: Implement a function to interact with the Deepgram STT endpoint, accepting a language parameter.
  - [x] Subtask 3.3: Add a placeholder for the Deepgram STT processor in the PipeCat pipeline, configured by the language detection step.
- [x] **Task 4: Connect STT Output to Agent Logic.**
  - [x] Subtask 4.1: Modify the main `agent-service` pipeline to pass the transcribed text from Deepgram to the existing query processing logic.
- [x] **Task 5: Add Unit Tests.**
  - [x] Subtask 5.1: Write unit tests for `SARVAMAiService.ts`, mocking the external API call.
  - [x] Subtask 5.2: Write unit tests for `deepgramSttService.ts`, mocking the external API call.
- [ ] **Task 6: Verify No Regressions.**
  - [ ] Subtask 6.1: Run the full test suite for the `agent-service` and the `api` to ensure no existing functionality is broken.

### File List

- `my-turborepo/packages/services/agent/src/SARVAMAiService.ts` (language detection service)
- `my-turborepo/packages/services/agent/src/deepgramSttService.ts` (Deepgram STT service)
- `my-turborepo/packages/services/agent/src/pipecatProcessors.ts` (language -> STT orchestrator)
- `my-turborepo/packages/services/agent/src/__tests__/SARVAMAiService.test.ts`
- `my-turborepo/packages/services/agent/src/__tests__/deepgramSttService.test.ts`
- `my-turborepo/packages/services/agent/src/__tests__/pipecatProcessors.test.ts`
- `my-turborepo/packages/services/agent/.env.example`

### Change Log

- Added `pipecatProcessors.ts` to orchestrate SARVAM AI -> Deepgram flow.
- Added test `pipecatProcessors.test.ts` to validate language detection and transcription flow.
- Added `.env.example` to document `DEEPGRAM_API_KEY` and `SARVAM_AI_API_KEY` for the `agent-service`.

### Status

In Progress
